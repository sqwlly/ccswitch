#!/bin/bash
# ccswitch - Claude Code 多供应商管理工具
# 支持多供应商配置、智能路由、故障转移

# 配置文件
CONFIG_FILE="$HOME/.claude/settings.json"
PROVIDERS_FILE="$HOME/.claude/providers.json"
BACKUP_DIR="$HOME/.claude/config-backups"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
REVERSE='\033[7m'
NC='\033[0m'

# 创建供应商配置文件
init_providers_file() {
    if [ ! -f "$PROVIDERS_FILE" ]; then
        cat > "$PROVIDERS_FILE" << 'EOF'
{
  "providers": [],
  "active_provider": "",
  "fallback_provider": "",
  "routing_mode": "primary",
  "auto_failover": true
}
EOF
    fi
}

show_header() {
    clear
    echo -e "${CYAN}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}  ${BOLD}CC Switch - 多供应商管理工具${NC}                             ${CYAN}║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo
}

read_input() {
    local prompt="$1"
    local default="$2"
    local result

    if [ -n "$default" ]; then
        printf "${CYAN}▸${NC} $prompt ${YELLOW}[$default]${NC}: " >&2
    else
        printf "${CYAN}▸${NC} $prompt: " >&2
    fi

    # 智能读取：优先 tty，回退到 stdin
    if [ -t 0 ]; then
        IFS= read -r result
    elif [ -t 1 ]; then
        IFS= read -r result < /dev/tty 2>/dev/null || IFS= read -r result
    else
        IFS= read -r result 2>/dev/null || result="$default"
    fi

    result=$(echo "$result" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [ -z "$result" ] && result="$default"
    printf "%s" "$result"
}

confirm() {
    local prompt="$1"
    local default="${2:-y}"
    local response

    if [ "$default" = "y" ]; then
        printf "${CYAN}▸${NC} $prompt ${YELLOW}[Y/n]${NC}: " >&2
    else
        printf "${CYAN}▸${NC} $prompt ${YELLOW}[y/N]${NC}: " >&2
    fi

    if [ -t 0 ]; then
        IFS= read -r response
    elif [ -t 1 ]; then
        IFS= read -r response < /dev/tty 2>/dev/null || IFS= read -r response
    else
        IFS= read -r response 2>/dev/null || response="$default"
    fi

    response=$(echo "$response" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    [ -z "$response" ] && response="$default"
    [[ "$response" =~ ^[Yy]$ ]]
}

# 交互式菜单选择 - 使用数字选择（简单可靠）
# 用法: select_from_list "标题" "选项1|选项2|..." [初始索引]
# 返回: 选中的索引 (从1开始), 255表示取消
select_from_list() {
    local title="$1"
    local options="$2"
    local initial_idx="${3:-1}"

    # 将选项转为数组
    IFS='|' read -ra OPT_ARRAY <<< "$options"
    local count=${#OPT_ARRAY[@]}
    [ $count -eq 0 ] && return 255

    while true; do
        clear
        show_header
        echo -e "${BOLD}[模式：$title]${NC}\n"

        # 显示选项（使用数字）
        for i in "${!OPT_ARRAY[@]}"; do
            local num=$((i + 1))
            if [ $num -eq $initial_idx ]; then
                printf "  ${GREEN}%d.${NC} ${BOLD}%s${NC} ${YELLOW}(当前)${NC}\n" "$num" "${OPT_ARRAY[$i]}"
            else
                printf "  ${GREEN}%d.${NC} %s\n" "$num" "${OPT_ARRAY[$i]}"
            fi
        done

        echo
        echo -e "${CYAN}输入选项编号确认，q 取消${NC}"
        echo -e "${BLUE}─────────────────────────────────────────────────────────────────${NC}"

        local choice
        choice=$(read_input "请选择" "$initial_idx")

        # 处理取消
        if [[ "$choice" =~ ^[qQ]$ ]]; then
            return 255
        fi

        # 验证输入是数字且在范围内
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "$count" ]; then
            return "$choice"
        else
            echo -e "${RED}✗ 无效选择，请输入 1-$count${NC}"
            sleep 1
        fi
    done
}

# 获取供应商列表（用于交互式选择）
# 返回: "id1|name1|id2|name2|..."
get_providers_for_selection() {
    local enabled_only="${1:-false}"
    python3 - "$PROVIDERS_FILE" "$enabled_only" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f:
    data = json.load(f)
providers = data.get('providers', [])
if sys.argv[2] == 'true':
    providers = [p for p in providers if p.get('enabled', True)]
for p in providers:
    print(f"{p['id']}|{p['name']}", end='||')
PYSCRIPT
}

get_providers() {
    python3 - "$PROVIDERS_FILE" << 'PYSCRIPT'
import json
import sys
try:
    with open(sys.argv[1], 'r') as f:
        data = json.load(f)
    for p in data.get('providers', []):
        print(f"{p['id']}|{p['name']}|{p.get('model', 'opus')}|{p.get('enabled', True)}")
except:
    pass
PYSCRIPT
}

show_status() {
    init_providers_file
    local active=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(d.get('active_provider', ''))" 2>/dev/null || echo "")
    local fallback=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(d.get('fallback_provider', ''))" 2>/dev/null || echo "")
    local mode=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(d.get('routing_mode', 'primary'))" 2>/dev/null || echo "")
    local failover=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(d.get('auto_failover', True))" 2>/dev/null || echo "True")
    local enabled_count=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(sum(1 for p in d.get('providers', []) if p.get('enabled', True)))" 2>/dev/null || echo "0")
    local status_color="$GREEN"
    [ -z "$active" ] && status_color="$RED"
    echo -e "${BLUE}┌─────────────────────────────────────────────────────────────────┐${NC}"
    printf "${BLUE}│${NC}  主供应商: ${status_color}%-25s${NC}  备用: ${CYAN}%-15s${NC} ${BLUE}│${NC}\n" "${active:-未设置}" "${fallback:-无}"
    printf "${BLUE}│${NC}  路由模式: ${YELLOW}%-12s${NC}  故障转移: ${YELLOW}%-8s${NC}  已启用: ${GREEN}%d 个${NC} ${BLUE}│${NC}\n" "$mode" "$failover" "$enabled_count"
    echo -e "${BLUE}└─────────────────────────────────────────────────────────────────┘${NC}"
    echo
}

# 主菜单
main_menu() {
    while true; do
        show_header
        show_status
        echo -e "${BOLD}[模式：主菜单]${NC}"
        echo
        echo -e "  ${GREEN}1.${NC} 供应商管理       ${CYAN}[添加/编辑/删除/启用禁用]${NC}"
        echo -e "  ${GREEN}2.${NC} 切换主供应商"
        echo -e "  ${GREEN}3.${NC} 路由设置"
        echo -e "  ${GREEN}4.${NC} 速度测试"
        echo -e "  ${GREEN}5.${NC} 查看配置"
        echo -e "  ${GREEN}6.${NC} 帮助"
        echo -e "  ${RED}0.${NC} 退出"
        echo
        echo -e "${BLUE}─────────────────────────────────────────────────────────────────${NC}"

        local choice=$(read_input "请选择操作" "0")

        case "$choice" in
            1) providers_menu ;;
            2) switch_primary_menu ;;
            3) routing_menu ;;
            4) speed_test_menu ;;
            5) show_config ;;
            6) show_help ;;
            0|q|Q) exit 0 ;;
            *) echo -e "${RED}✗ 无效选择${NC}"; sleep 1 ;;
        esac
    done
}

# 供应商管理
providers_menu() {
    while true; do
        show_header
        echo -e "${BOLD}[模式：供应商管理]${NC}\n"
        echo -e "${CYAN}已配置的供应商:${NC}\n"
        local providers=$(get_providers)
        if [ -z "$providers" ]; then
            echo -e "${YELLOW}  暂无配置，请添加供应商${NC}\n"
        else
            local active=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(d.get('active_provider', ''))" 2>/dev/null || echo "")
            echo "$providers" | while IFS='|' read -r id name model enabled; do
                local status="${GREEN}✓${NC}"; local marker=" "
                [ "$enabled" = "False" ] && status="${RED}✗${NC}"
                [ "$id" = "$active" ] && marker="${YELLOW}*${NC}"
                printf "  $marker ${GREEN}%-20s${NC} ${CYAN}%-15s${NC} 模型: ${YELLOW}%-8s${NC} 状态: $status\n" "$name" "$id" "$model"
            done
            echo
        fi
        echo -e "${BLUE}─────────────────────────────────────────────────────────────────${NC}"
        echo -e "  ${GREEN}a.${NC} 添加供应商"
        echo -e "  ${GREEN}e.${NC} 编辑供应商"
        echo -e "  ${GREEN}d.${NC} 删除供应商"
        echo -e "  ${GREEN}t.${NC} 启用/禁用"
        echo -e "  ${GREEN}b.${NC} 返回"
        echo -e "${BLUE}─────────────────────────────────────────────────────────────────${NC}"

        local choice=$(read_input "请选择" "b")
        case "$choice" in
            a|A) add_provider ;;
            e|E) edit_provider ;;
            d|D) delete_provider ;;
            t|T) toggle_provider ;;
            b|B) return ;;
        esac
    done
}

add_provider() {
    show_header
    echo -e "${BOLD}[模式：添加供应商]${NC}\n"
    echo -e "${YELLOW}选择预设:${NC} 1)官方 2)智谱 3)自定义\n"
    local choice=$(read_input "请选择" "2")
    local name url desc
    case "$choice" in
        1) name="official"; url="https://api.anthropic.com"; desc="Anthropic 官方" ;;
        2) name="bigmodel"; url="https://open.bigmodel.cn/api/anthropic"; desc="智谱 GLM" ;;
        *) name=$(read_input "供应商ID" ""); url=$(read_input "API URL" ""); desc="自定义" ;;
    esac
    [ -z "$name" ] && return
    local token=""
    [ "$name" != "official" ] && token=$(read_input "API Token" "")
    echo -e "${YELLOW}选择模型: 1)opus 2)sonnet 3)haiku${NC}"
    local model_choice=$(read_input "请选择" "1")
    local model="opus"
    case "$model_choice" in 2) model="sonnet";; 3) model="haiku";; esac

    python3 - "$PROVIDERS_FILE" "$name" "$url" "$desc" "$token" "$model" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f: data = json.load(f)
data['providers'].append({'id': sys.argv[2], 'url': sys.argv[3], 'name': sys.argv[4], 'token': sys.argv[5] if sys.argv[5] else '', 'model': sys.argv[6], 'enabled': True})
with open(sys.argv[1], 'w') as f: json.dump(data, f, indent=2)
PYSCRIPT
    echo -e "${GREEN}✓ 已添加${NC}"
    sleep 1
}

edit_provider() {
    show_header
    echo -e "${BOLD}[模式：编辑供应商]${NC}\n"
    local providers=$(get_providers)
    [ -z "$providers" ] && echo -e "${RED}✗ 暂无供应商${NC}" && sleep 1 && return

    # 构建选项列表（不使用颜色，避免转义问题）
    local options=""
    local id_array=()
    while IFS='|' read -r id name model enabled; do
        local status="[启用]"; [ "$enabled" = "False" ] && status="[禁用]"
        options="${options}${id} - $name $status|"
        id_array+=("$id")
    done <<< "$providers"

    # 交互式选择
    select_from_list "编辑供应商" "$options"
    local idx=$?
    [ $idx -eq 255 ] && return
    local choice="${id_array[$((idx-1))]}"

    # 获取当前供应商配置
    local current=$(python3 - "$PROVIDERS_FILE" "$choice" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f: data = json.load(f)
for p in data.get('providers', []):
    if p['id'] == sys.argv[2]:
        print(f"{p.get('url', '')}|{p.get('token', '')}|{p.get('model', 'opus')}|{p.get('name', '')}")
        break
PYSCRIPT
)
    [ -z "$current" ] && echo -e "${RED}✗ 未找到供应商: $choice${NC}" && sleep 1 && return

    IFS='|' read -r cur_url cur_token cur_model cur_name <<< "$current"

    show_header
    echo -e "${BOLD}[模式：编辑供应商 - $choice]${NC}\n"
    echo -e "${CYAN}当前配置:${NC}"
    echo -e "  名称: ${YELLOW}$cur_name${NC}"
    echo -e "  URL:  ${YELLOW}$cur_url${NC}"
    echo -e "  模型: ${YELLOW}$cur_model${NC}"
    echo -e "  Token: ${YELLOW}${cur_token:0:20}...${NC}\n"

    echo -e "${CYAN}输入新值（留空保持不变）:${NC}\n"

    local new_name=$(read_input "名称" "$cur_name")
    local new_url=$(read_input "API URL" "$cur_url")
    local new_token=$(read_input "Token" "")
    [ -z "$new_token" ] && new_token="$cur_token"

    echo -e "\n${YELLOW}选择模型: 1)opus 2)sonnet 3)haiku${NC}"
    local model_hint="1"
    case "$cur_model" in opus) model_hint="1";; sonnet) model_hint="2";; haiku) model_hint="3";; esac
    local model_choice=$(read_input "请选择" "$model_hint")
    local new_model="opus"
    case "$model_choice" in 2) new_model="sonnet";; 3) new_model="haiku";; esac

    python3 - "$PROVIDERS_FILE" "$choice" "$new_url" "$new_name" "$new_token" "$new_model" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f: data = json.load(f)
for p in data['providers']:
    if p['id'] == sys.argv[2]:
        p['url'] = sys.argv[3]
        p['name'] = sys.argv[4]
        p['token'] = sys.argv[5]
        p['model'] = sys.argv[6]
        break
with open(sys.argv[1], 'w') as f: json.dump(data, f, indent=2)
PYSCRIPT
    echo -e "${GREEN}✓ 供应商已更新${NC}"
    sleep 1
}

delete_provider() {
    show_header
    echo -e "${BOLD}[模式：删除供应商]${NC}\n"
    local providers=$(get_providers)
    [ -z "$providers" ] && echo -e "${RED}✗ 暂无供应商${NC}" && sleep 1 && return

    # 构建选项列表（不使用颜色，避免转义问题）
    local options=""
    local id_array=()
    while IFS='|' read -r id name model enabled; do
        local status="[启用]"; [ "$enabled" = "False" ] && status="[禁用]"
        options="${options}${id} - $name $status|"
        id_array+=("$id")
    done <<< "$providers"

    # 交互式选择
    select_from_list "删除供应商" "$options"
    local idx=$?
    [ $idx -eq 255 ] && return
    local choice="${id_array[$((idx-1))]}"

    # 二次确认
    confirm "确认删除供应商: $choice?" "n" || return

    python3 - "$PROVIDERS_FILE" "$choice" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f: data = json.load(f)
data['providers'] = [p for p in data['providers'] if p['id'] != sys.argv[2]]
if data.get('active_provider') == sys.argv[2]: data['active_provider'] = ''
with open(sys.argv[1], 'w') as f: json.dump(data, f, indent=2)
PYSCRIPT
    echo -e "${GREEN}✓ 已删除${NC}"
    sleep 1
}

toggle_provider() {
    show_header
    echo -e "${BOLD}[模式：启用/禁用]${NC}\n"
    local providers=$(get_providers)
    [ -z "$providers" ] && echo -e "${RED}✗ 暂无供应商${NC}" && sleep 1 && return

    # 构建选项列表（不使用颜色，避免转义问题）
    local options=""
    local id_array=()
    while IFS='|' read -r id name model enabled; do
        local status="[启用]"; [ "$enabled" = "False" ] && status="[禁用]"
        options="${options}${id} - $name $status|"
        id_array+=("$id")
    done <<< "$providers"

    # 交互式选择
    select_from_list "启用/禁用供应商" "$options"
    local idx=$?
    [ $idx -eq 255 ] && return
    local choice="${id_array[$((idx-1))]}"

    python3 - "$PROVIDERS_FILE" "$choice" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f: data = json.load(f)
for p in data['providers']:
    if p['id'] == sys.argv[2]: p['enabled'] = not p.get('enabled', True); break
with open(sys.argv[1], 'w') as f: json.dump(data, f, indent=2)
PYSCRIPT
    echo -e "${GREEN}✓ 状态已切换${NC}"
    sleep 1
}

switch_primary_menu() {
    local active=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(d.get('active_provider', ''))" 2>/dev/null || echo "")

    # 获取已启用的供应商
    local providers_data=$(get_providers | grep "|True$")
    [ -z "$providers_data" ] && show_header && echo -e "${BOLD}[模式：切换主供应商]${NC}\n" && echo -e "${RED}✗ 无可用供应商${NC}" && sleep 1 && return

    # 构建选项列表，并找到当前激活的索引（不使用颜色，避免转义问题）
    local options=""
    local id_array=()
    local initial_idx=1
    local index=1
    while IFS='|' read -r id name model enabled; do
        local marker=""
        [ "$id" = "$active" ] && marker="* " && initial_idx=$index
        options="${options}${marker}${id} - ${name} (${model})|"
        id_array+=("$id")
        ((index++))
    done <<< "$providers_data"

    # 交互式选择
    select_from_list "切换主供应商" "$options" "$initial_idx"
    local idx=$?
    [ $idx -eq 255 ] && return
    local selected_id="${id_array[$((idx-1))]}"

    apply_provider "$selected_id"
}

apply_provider() {
    local provider_id="$1"

    # 获取供应商信息（使用无引号 heredoc 允许变量展开）
    local info=$(python3 << PYSCRIPT
import json, sys
with open('${PROVIDERS_FILE}', 'r') as f: data = json.load(f)
for p in data.get('providers', []):
    if p['id'] == '${provider_id}' and p.get('enabled', True):
        print(f"{p['url']}|{p.get('token', '')}|{p.get('model', 'opus')}|{p.get('name', '')}")
        break
PYSCRIPT
)
    [ -z "$info" ] && echo -e "${RED}✗ 供应商不存在或已禁用${NC}" && sleep 1 && return
    IFS='|' read -r url token model name <<< "$info"

    # 更新配置
    mkdir -p "$BACKUP_DIR"
    cp "$CONFIG_FILE" "$BACKUP_DIR/settings_$(date +%Y%m%d_%H%M%S).json" 2>/dev/null || true

    python3 << PYSCRIPT
import json, sys
with open('${CONFIG_FILE}', 'r') as f: config = json.load(f)
if 'env' not in config: config['env'] = {}

# 删除旧的 API_KEY 避免冲突
if 'ANTHROPIC_API_KEY' in config['env']:
    del config['env']['ANTHROPIC_API_KEY']

# 设置新的供应商配置
config['env']['ANTHROPIC_BASE_URL'] = '${url}'
if '${token}':
    config['env']['ANTHROPIC_AUTH_TOKEN'] = '${token}'
elif 'ANTHROPIC_AUTH_TOKEN' in config['env']:
    del config['env']['ANTHROPIC_AUTH_TOKEN']

config['env']['ANTHROPIC_MODEL'] = '${model}'

# GLM 特殊模型映射
if 'bigmodel.cn' in '${url}':
    config['env']['ANTHROPIC_DEFAULT_OPUS_MODEL'] = 'glm-4.7'
    config['env']['ANTHROPIC_DEFAULT_SONNET_MODEL'] = 'glm-4.7'
    config['env']['ANTHROPIC_DEFAULT_HAIKU_MODEL'] = 'glm-4.5-air'
else:
    # 清除 GLM 模型配置
    for k in ['ANTHROPIC_DEFAULT_OPUS_MODEL', 'ANTHROPIC_DEFAULT_SONNET_MODEL', 'ANTHROPIC_DEFAULT_HAIKU_MODEL']:
        if k in config['env']:
            del config['env'][k]

with open('${CONFIG_FILE}', 'w') as f: json.dump(config, f, indent=2)

# 更新活跃供应商
with open('${PROVIDERS_FILE}', 'r') as f: data = json.load(f)
data['active_provider'] = '${provider_id}'
with open('${PROVIDERS_FILE}', 'w') as f: json.dump(data, f, indent=2)
PYSCRIPT

    echo
    echo -e "${GREEN}✓ 已切换到: $name ($provider_id)${NC}"
    echo -e "${YELLOW}请重启 Claude Code${NC}"
    read_input "按回车继续" > /dev/null
}

# 路由设置菜单
routing_menu() {
    while true; do
        show_header
        echo -e "${BOLD}[模式：路由设置]${NC}\n"
        local current_mode=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(d.get('routing_mode', 'primary'))" 2>/dev/null || echo "primary")
        local fallback=$(python3 -c "import json; d=json.load(open('$PROVIDERS_FILE')); print(d.get('fallback_provider', '未设置'))" 2>/dev/null || echo "未设置")
        echo -e "${CYAN}当前设置:${NC}"
        echo -e "  路由模式: ${YELLOW}$current_mode${NC}"
        echo -e "  备用供应商: ${YELLOW}$fallback${NC}\n"
        echo -e "${BLUE}─────────────────────────────────────────────────────────────────${NC}"
        echo -e "  ${GREEN}1${NC}. 设置路由模式"
        echo -e "  ${GREEN}2${NC}. 设置备用供应商"
        echo -e "  ${GREEN}b${NC}. 返回"
        echo -e "${BLUE}─────────────────────────────────────────────────────────────────${NC}"
        local choice=$(read_input "请选择" "b")
        case "$choice" in
            1) set_routing_mode; sleep 1 ;;
            2) set_fallback_provider; sleep 1 ;;
            b|B) return ;;
        esac
    done
}

set_routing_mode() {
    echo
    echo -e "${YELLOW}路由模式: 1)primary 2)round_robin 3)smart${NC}"
    local choice=$(read_input "请选择" "1")
    local mode="primary"
    case "$choice" in 2) mode="round_robin";; 3) mode="smart";; esac
    python3 - "$PROVIDERS_FILE" "$mode" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f: data = json.load(f)
data['routing_mode'] = sys.argv[2]
with open(sys.argv[1], 'w') as f: json.dump(data, f, indent=2)
PYSCRIPT
    echo -e "${GREEN}✓ 路由模式: $mode${NC}"
}

set_fallback_provider() {
    local providers=$(get_providers | grep "|True$")
    [ -z "$providers" ] && echo -e "${RED}✗ 无可用供应商${NC}" && sleep 1 && return

    # 构建选项列表（不使用颜色，避免转义问题）
    local options=""
    local id_array=()
    while IFS='|' read -r id name model enabled; do
        options="${options}${id} - ${name} (${model})|"
        id_array+=("$id")
    done <<< "$providers"

    # 交互式选择
    select_from_list "设置备用供应商" "$options"
    local idx=$?
    [ $idx -eq 255 ] && return
    local choice="${id_array[$((idx-1))]}"

    python3 - "$PROVIDERS_FILE" "$choice" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f: data = json.load(f)
data['fallback_provider'] = sys.argv[2]
with open(sys.argv[1], 'w') as f: json.dump(data, f, indent=2)
PYSCRIPT
    echo -e "${GREEN}✓ 备用供应商: $choice${NC}"
}

# 速度测试
speed_test_menu() {
    show_header
    echo -e "${BOLD}[模式：速度测试]${NC}\n"
    echo -e "${CYAN}测试所有已启用的供应商...${NC}\n"

    python3 - "$PROVIDERS_FILE" << 'PYSCRIPT'
import json, sys, time, urllib.request, ssl

with open(sys.argv[1], 'r') as f:
    data = json.load(f)

providers = [p for p in data.get('providers', []) if p.get('enabled', True)]
if not providers:
    print("\033[31m✗ 没有已启用的供应商\033[0m")
    sys.exit(0)

# 创建忽略 SSL 验证的上下文（仅用于测试连通性）
ctx = ssl.create_default_context()
ctx.check_hostname = False
ctx.verify_mode = ssl.CERT_NONE

for p in providers:
    base_url = p['url'].rstrip('/')
    name = p.get('name', p['id'])
    token = p.get('token', '')

    # 尝试多个可能的端点
    endpoints = ['/v1/messages', '/v1/models', '/v1/chat/completions', '']
    success = False

    for endpoint in endpoints:
        test_url = f"{base_url}{endpoint}"
        start = time.time()
        try:
            req = urllib.request.Request(test_url, method='HEAD' if not endpoint else 'POST')
            req.add_header('Content-Type', 'application/json')
            if token:
                req.add_header('x-api-key', token)
                req.add_header('Authorization', f'Bearer {token}')
                req.add_header('anthropic-version', '2023-06-01')

            if req.get_method() == 'POST':
                req.data = b'{}'

            with urllib.request.urlopen(req, timeout=10, context=ctx) as response:
                elapsed = int((time.time() - start) * 1000)
                print(f"  {name:20s} {elapsed:4d}ms  \033[32m✓ 正常\033[0m")
                success = True
                break
        except urllib.request.HTTPError as e:
            elapsed = int((time.time() - start) * 1000)
            # 400/401/403/422/500 表示端点存在（服务器响应了）
            if e.code in [400, 401, 403, 422, 500]:
                print(f"  {name:20s} {elapsed:4d}ms  \033[32m✓ 可达\033[0m")
                success = True
                break
            elif e.code == 404:
                continue  # 尝试下一个端点
            else:
                print(f"  {name:20s} {elapsed:4d}ms  \033[33m⚠ HTTP {e.code}\033[0m")
                success = True
                break
        except Exception as e:
            elapsed = int((time.time() - start) * 1000)
            if endpoint == endpoints[-1]:  # 最后一个端点
                err_msg = str(e)[:25]
                print(f"  {name:20s} {elapsed:4d}ms  \033[31m✗ {err_msg}\033[0m")
                success = True
            continue

    if not success:
        print(f"  {name:20s}    --ms  \033[31m✗ 所有端点不可达\033[0m")
PYSCRIPT

    echo
    read_input "按回车返回" > /dev/null
}

show_config() {
    show_header
    echo -e "${BOLD}[模式：查看配置]${NC}\n"
    echo -e "${CYAN}供应商配置:${NC}\n"
    cat "$PROVIDERS_FILE" 2>/dev/null | head -20
    echo
    read_input "按回车返回" > /dev/null
}

show_help() {
    show_header
    echo -e "${BOLD}[模式：帮助]${NC}\n"
    echo -e "${CYAN}CC Switch - 多供应商管理工具${NC}\n"
    echo -e "${YELLOW}功能:${NC}"
    echo "  • 多供应商配置管理"
    echo "  • 快速切换主供应商"
    echo "  • 设置备用供应商（故障转移）"
    echo "  • 路由模式: primary / round_robin / smart"
    echo
    echo -e "${YELLOW}配置文件:${NC}"
    echo "  ~/.claude/settings.json   - Claude 配置"
    echo "  ~/.claude/providers.json  - 供应商配置"
    read_input "按回车返回" > /dev/null
}

# 命令行模式
cli_mode() {
    case "${1:-}" in
        --current|-c)
            init_providers_file
            python3 - "$PROVIDERS_FILE" "$CONFIG_FILE" << 'PYSCRIPT'
import json, sys
with open(sys.argv[1], 'r') as f: d = json.load(f)
with open(sys.argv[2], 'r') as f: c = json.load(f)
print(f"主供应商: {d.get('active_provider', '未设置')}")
print(f"路由模式: {d.get('routing_mode', 'primary')}")
print(f"当前URL: {c['env'].get('ANTHROPIC_BASE_URL', '')}")
print(f"当前模型: {c['env'].get('ANTHROPIC_MODEL', '')}")
PYSCRIPT
            ;;
        --list|-l)
            echo "预设供应商: official, bigmodel"
            ;;
        --help|-h)
            echo "CC Switch - 多供应商管理工具"
            echo "交互模式: ccswitch"
            echo "命令模式: --current, --list, --use"
            ;;
        *) return 1 ;;
    esac
    exit 0
}

main() {
    cli_mode "$@" 2>/dev/null && exit 0 || true
    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${RED}✗ Claude 配置文件不存在${NC}"
        exit 1
    fi
    init_providers_file
    main_menu
}

main "$@"

